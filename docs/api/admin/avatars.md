# Admin Avatar Management API

## Overview

The Admin Avatar Management API provides user avatar image upload, retrieval, and deletion capabilities. It leverages Cloudflare R2 for storage and Cloudflare Image Resizing for on-demand image optimization.

**Key Features:**
- Upload user avatar images (JPEG, PNG, GIF, WebP)
- Automatic file validation (type, size)
- Delete user avatars
- Serve avatars with automatic CDN caching
- Support for Cloudflare Image Resizing for on-the-fly transformations

**Authentication:**
- Requires admin privileges (Phase 6)
- Bearer token authentication (Phase 6)
- RBAC permissions: `users:write` for upload/delete (Phase 6)

## Base URL

```
https://your-domain.com/admin/users/:id/avatar
```

## Storage Architecture

- **Storage Backend:** Cloudflare R2
- **Bucket:** `authrim-avatars`
- **File Path:** `avatars/{userId}.{ext}`
- **Image Resizing:** Cloudflare Image Resizing (via `/cdn-cgi/image/` prefix)

## Endpoints

### 1. Upload User Avatar

Upload a new avatar image for a user. Replaces any existing avatar.

**Endpoint:** `POST /admin/users/:id/avatar`

**Path Parameters:**
| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `id` | string | Yes | User ID (UUID) |

**Request Headers:**
```
Content-Type: multipart/form-data
Authorization: Bearer YOUR_ADMIN_TOKEN
```

**Request Body:**
| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `avatar` | File | Yes | Avatar image file |

**File Requirements:**
- **Allowed Types:** `image/jpeg`, `image/png`, `image/gif`, `image/webp`
- **Maximum Size:** 5 MB
- **Recommended Size:** 512x512 px (will be resized on delivery)

**Response (200 OK):**
```json
{
  "success": true,
  "avatarUrl": "https://your-domain.com/avatars/user_123.jpg",
  "message": "Avatar uploaded successfully"
}
```

**Error Responses:**

| Status Code | Error | Description |
|-------------|-------|-------------|
| 400 | `invalid_request` | Missing avatar file, invalid file type, or file too large |
| 401 | `unauthorized` | Missing or invalid authentication token |
| 403 | `forbidden` | Insufficient permissions |
| 404 | `not_found` | User not found |
| 500 | `server_error` | Failed to upload avatar |

**Example:**
```bash
# Upload avatar for user
curl -X POST "https://your-domain.com/admin/users/user_123/avatar" \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -F "avatar=@/path/to/avatar.jpg"
```

**Example Response (400 - Invalid File Type):**
```json
{
  "error": "invalid_request",
  "error_description": "Invalid file type. Allowed types: JPEG, PNG, GIF, WebP"
}
```

**Example Response (400 - File Too Large):**
```json
{
  "error": "invalid_request",
  "error_description": "File size exceeds 5MB limit"
}
```

---

### 2. Delete User Avatar

Delete a user's avatar image.

**Endpoint:** `DELETE /admin/users/:id/avatar`

**Path Parameters:**
| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `id` | string | Yes | User ID (UUID) |

**Request Headers:**
```
Authorization: Bearer YOUR_ADMIN_TOKEN
```

**Response (200 OK):**
```json
{
  "success": true,
  "message": "Avatar deleted successfully"
}
```

**Error Responses:**

| Status Code | Error | Description |
|-------------|-------|-------------|
| 401 | `unauthorized` | Missing or invalid authentication token |
| 403 | `forbidden` | Insufficient permissions |
| 404 | `not_found` | User not found or user does not have an avatar |
| 500 | `server_error` | Failed to delete avatar |

**Example:**
```bash
# Delete user's avatar
curl -X DELETE "https://your-domain.com/admin/users/user_123/avatar" \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN"
```

**Example Response (404 - No Avatar):**
```json
{
  "error": "not_found",
  "error_description": "User does not have an avatar"
}
```

---

### 3. Serve Avatar Image (Public)

Retrieve a user's avatar image. This endpoint is public and does not require authentication.

**Endpoint:** `GET /avatars/:filename`

**Path Parameters:**
| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `filename` | string | Yes | Avatar filename (e.g., `user_123.jpg`) |

**Response (200 OK):**
- **Content-Type:** `image/jpeg`, `image/png`, `image/gif`, or `image/webp`
- **Cache-Control:** `public, max-age=31536000, immutable`
- **ETag:** Generated by R2

**Error Responses:**

| Status Code | Error | Description |
|-------------|-------|-------------|
| 404 | `not_found` | Avatar not found |
| 500 | `server_error` | Failed to serve avatar |

**Example:**
```bash
# Get avatar image
curl "https://your-domain.com/avatars/user_123.jpg"
```

---

## Image Resizing with Cloudflare

Avatars can be resized on-the-fly using Cloudflare Image Resizing by adding the `/cdn-cgi/image/` prefix with transformation parameters.

**URL Format:**
```
https://your-domain.com/cdn-cgi/image/{options}/avatars/{filename}
```

**Common Options:**
- `width={w}` - Resize width
- `height={h}` - Resize height
- `fit=cover` - Crop to exact dimensions
- `quality={q}` - JPEG/WebP quality (1-100)
- `format=auto` - Auto-convert to WebP/AVIF

**Examples:**
```bash
# Thumbnail (200x200, cropped)
https://your-domain.com/cdn-cgi/image/width=200,height=200,fit=cover/avatars/user_123.jpg

# Large avatar with quality optimization
https://your-domain.com/cdn-cgi/image/width=512,quality=80,format=auto/avatars/user_123.jpg

# Mobile-optimized (auto WebP/AVIF)
https://your-domain.com/cdn-cgi/image/width=128,quality=75,format=auto/avatars/user_123.jpg
```

**Pricing:**
- First 5,000 unique transformations/month: **Free**
- Additional transformations: $0.50 per 1,000 unique transformations
- **Note:** Same image + same size = counted once per month (cached)

---

## Integration with User API

After uploading an avatar, the user's `picture` field is automatically updated with the avatar URL:

```json
{
  "id": "user_123",
  "email": "user@example.com",
  "name": "John Doe",
  "picture": "https://your-domain.com/avatars/user_123.jpg",
  ...
}
```

This URL is also included in OIDC UserInfo responses and ID tokens as the `picture` claim.

---

## Update User Picture URL (Alternative Method)

You can also update a user's `picture` field directly via the User Update API to use an external URL:

**Endpoint:** `PUT /admin/users/:id`

**Request Body:**
```json
{
  "picture": "https://external-cdn.com/avatar.jpg"
}
```

This is useful for:
- Using external avatar services (Gravatar, social media, etc.)
- Referencing images hosted elsewhere
- Migrating existing avatar URLs

See [User Management API](./users.md#4-update-user) for details.

---

## Setup Instructions

### 1. Create R2 Bucket

```bash
# Create production bucket
wrangler r2 bucket create authrim-avatars

# Create preview bucket (for development)
wrangler r2 bucket create authrim-avatars-preview
```

### 2. Configure wrangler.toml

Add to your `packages/op-management/wrangler.toml`:

```toml
[[r2_buckets]]
binding = "AVATARS"
bucket_name = "authrim-avatars"
preview_bucket_name = "authrim-avatars-preview"
```

### 3. Enable Cloudflare Image Resizing

Image Resizing is available on all Cloudflare plans (including Free):
- Free tier: 5,000 transformations/month
- No additional setup required
- Works automatically with the `/cdn-cgi/image/` URL prefix

---

## Best Practices

### File Upload
1. **Validate files on client-side** before uploading to reduce errors
2. **Compress images** before upload (recommended: < 1 MB)
3. **Use recommended dimensions** (512x512 px) for optimal quality/size balance

### Image Delivery
1. **Always use Image Resizing URLs** for avatars in UI (e.g., `width=200`)
2. **Use `format=auto`** to serve WebP/AVIF to modern browsers
3. **Cache avatar URLs** in your application to reduce API calls

### Storage Management
1. **Delete old avatars** when uploading new ones (automatically handled)
2. **Monitor R2 storage** usage in Cloudflare dashboard
3. **Consider cleanup jobs** for deleted users' avatars

---

## Related Documentation

- [User Management API](./users.md)
- [Cloudflare R2 Documentation](https://developers.cloudflare.com/r2/)
- [Cloudflare Image Resizing](https://developers.cloudflare.com/images/image-resizing/)
