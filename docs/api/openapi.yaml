openapi: 3.1.0
info:
  title: Enrai OIDC OP API
  version: 1.0.0
  description: |
    Enrai is a modern OpenID Connect Provider (OP) built for the edge.

    **Features**:
    - ‚úÖ OIDC Core 1.0 compliant
    - ‚úÖ RFC 7591 (DCR), RFC 9126 (PAR), RFC 7662 (Introspection), RFC 7009 (Revocation)
    - üîê Passwordless authentication (Passkey + Magic Link)
    - üë• Admin Dashboard with RBAC
    - üåê ITP-compatible cross-domain SSO
    - üöÄ Edge-native (Cloudflare Workers)

    **Current Status**:
    - Phase 4 Complete: OIDC Core + Extensions
    - Phase 5 Planning: UI/UX + Admin APIs

    **Documentation**: https://github.com/sgrastar/enrai
  contact:
    name: Enrai Development Team
    url: https://github.com/sgrastar/enrai
  license:
    name: Apache-2.0
    url: https://www.apache.org/licenses/LICENSE-2.0

servers:
  - url: https://auth.example.com
    description: Production server
  - url: https://auth-staging.example.com
    description: Staging server
  - url: http://localhost:8787
    description: Local development

tags:
  - name: OIDC Core
    description: OpenID Connect Core 1.0 endpoints (‚úÖ Phase 2 - Implemented)
  - name: OIDC Extensions
    description: DCR, PAR, Introspection, Revocation (‚úÖ Phase 4 - Implemented)
  - name: Authentication UI
    description: Passkey and Magic Link APIs (üìù Phase 5 - Planned)
  - name: Admin - Users
    description: User management APIs (üìù Phase 5 - Planned)
  - name: Admin - Clients
    description: Client management APIs (üìù Phase 5 - Planned)
  - name: Admin - Stats
    description: Statistics and analytics (üìù Phase 5 - Planned)
  - name: Session Management
    description: ITP-compatible session APIs (üìù Phase 5 - Planned)
  - name: Logout
    description: Front-channel and Back-channel logout (üìù Phase 5 - Planned)

security:
  - BearerAuth: []
  - OAuth2: [openid, profile, email]

paths:
  /.well-known/openid-configuration:
    get:
      tags:
        - OIDC Core
      summary: OpenID Provider Configuration
      description: |
        Returns OpenID Provider metadata as defined in OIDC Discovery 1.0.

        **Status**: ‚úÖ Implemented (Phase 2)
      operationId: getOpenIDConfiguration
      security: []
      responses:
        '200':
          description: OpenID Provider Configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OIDCConfiguration'
              example:
                issuer: https://auth.example.com
                authorization_endpoint: https://auth.example.com/authorize
                token_endpoint: https://auth.example.com/token
                userinfo_endpoint: https://auth.example.com/userinfo
                jwks_uri: https://auth.example.com/.well-known/jwks.json
                registration_endpoint: https://auth.example.com/register
                scopes_supported:
                  - openid
                  - profile
                  - email
                  - address
                  - phone
                response_types_supported:
                  - code
                  - token
                  - id_token
                  - code id_token
                  - code token
                  - id_token token
                  - code id_token token
                grant_types_supported:
                  - authorization_code
                  - refresh_token
                subject_types_supported:
                  - public
                  - pairwise
                id_token_signing_alg_values_supported:
                  - RS256
                  - ES256
                token_endpoint_auth_methods_supported:
                  - client_secret_basic
                  - client_secret_post
                  - client_secret_jwt
                  - private_key_jwt
                code_challenge_methods_supported:
                  - S256
                  - plain

  /.well-known/jwks.json:
    get:
      tags:
        - OIDC Core
      summary: JSON Web Key Set
      description: |
        Returns the set of public keys used to verify ID tokens and other JWTs.

        **Status**: ‚úÖ Implemented (Phase 2)
      operationId: getJWKS
      security: []
      responses:
        '200':
          description: JSON Web Key Set
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JWKS'

  /authorize:
    get:
      tags:
        - OIDC Core
      summary: Authorization Endpoint (GET)
      description: |
        OAuth 2.0 / OIDC authorization endpoint. Initiates the authentication flow.

        **Status**: ‚úÖ Implemented (Phase 2)

        **Features**:
        - PKCE support (RFC 7636)
        - PAR support (RFC 9126)
        - Claims parameter support
        - ui_locales support
      operationId: authorize
      security: []
      parameters:
        - name: response_type
          in: query
          required: true
          schema:
            type: string
            enum: [code, token, id_token, 'code id_token', 'code token', 'id_token token', 'code id_token token']
          example: code
        - name: client_id
          in: query
          required: true
          schema:
            type: string
          example: client_123456
        - name: redirect_uri
          in: query
          required: true
          schema:
            type: string
            format: uri
          example: https://myapp.com/callback
        - name: scope
          in: query
          required: true
          schema:
            type: string
          example: openid profile email
        - name: state
          in: query
          required: true
          schema:
            type: string
          example: random_state_string
        - name: nonce
          in: query
          schema:
            type: string
          example: random_nonce_string
        - name: code_challenge
          in: query
          description: PKCE code challenge (RFC 7636)
          schema:
            type: string
          example: E9Melhoa2OwvFrEMTJguCHaoeK1t8URWbuGJSstw-cM
        - name: code_challenge_method
          in: query
          schema:
            type: string
            enum: [plain, S256]
            default: S256
        - name: prompt
          in: query
          schema:
            type: string
            enum: [none, login, consent, select_account]
        - name: max_age
          in: query
          schema:
            type: integer
        - name: ui_locales
          in: query
          schema:
            type: string
          example: ja en
        - name: claims
          in: query
          description: Requested claims (JSON)
          schema:
            type: string
        - name: request_uri
          in: query
          description: PAR request_uri (RFC 9126)
          schema:
            type: string
      responses:
        '302':
          description: Redirect to consent page or callback URL
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OAuthError'
        '401':
          description: Unauthorized (login required)

    post:
      tags:
        - OIDC Core
      summary: Authorization Endpoint (POST)
      description: |
        Same as GET /authorize but via POST. Useful for large requests.

        **Status**: ‚úÖ Implemented (Phase 2)
      operationId: authorizePost
      security: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - response_type
                - client_id
                - redirect_uri
                - scope
                - state
              properties:
                response_type:
                  type: string
                client_id:
                  type: string
                redirect_uri:
                  type: string
                scope:
                  type: string
                state:
                  type: string
                nonce:
                  type: string
                code_challenge:
                  type: string
                code_challenge_method:
                  type: string
      responses:
        '302':
          description: Redirect to consent page or callback URL
        '400':
          description: Invalid request

  /token:
    post:
      tags:
        - OIDC Core
      summary: Token Endpoint
      description: |
        Exchange authorization code for tokens or refresh access tokens.

        **Status**: ‚úÖ Implemented (Phase 2)

        **Supported grant types**:
        - authorization_code
        - refresh_token

        **Features**:
        - PKCE verification
        - Refresh token rotation
        - DPoP support (RFC 9449)
      operationId: token
      security:
        - ClientSecretBasic: []
        - ClientSecretPost: []
      parameters:
        - name: DPoP
          in: header
          description: DPoP proof JWT (RFC 9449)
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              oneOf:
                - $ref: '#/components/schemas/AuthorizationCodeGrant'
                - $ref: '#/components/schemas/RefreshTokenGrant'
      responses:
        '200':
          description: Token response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OAuthError'
        '401':
          description: Client authentication failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OAuthError'

  /userinfo:
    get:
      tags:
        - OIDC Core
      summary: UserInfo Endpoint (GET)
      description: |
        Returns claims about the authenticated user.

        **Status**: ‚úÖ Implemented (Phase 2)
      operationId: userinfo
      security:
        - BearerAuth: []
      responses:
        '200':
          description: User information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserInfo'
        '401':
          description: Invalid or expired access token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OAuthError'

    post:
      tags:
        - OIDC Core
      summary: UserInfo Endpoint (POST)
      description: |
        Same as GET /userinfo but via POST.

        **Status**: ‚úÖ Implemented (Phase 2)
      operationId: userinfoPost
      security:
        - BearerAuth: []
      responses:
        '200':
          description: User information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserInfo'

  /register:
    post:
      tags:
        - OIDC Extensions
      summary: Dynamic Client Registration
      description: |
        Register a new OAuth 2.0 client dynamically (RFC 7591).

        **Status**: ‚úÖ Implemented (Phase 4)
      operationId: registerClient
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClientRegistrationRequest'
      responses:
        '201':
          description: Client registered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientRegistrationResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OAuthError'

  /as/par:
    post:
      tags:
        - OIDC Extensions
      summary: Pushed Authorization Request
      description: |
        Push authorization request parameters and obtain request_uri (RFC 9126).

        **Status**: ‚úÖ Implemented (Phase 4)
      operationId: pushedAuthorizationRequest
      security:
        - ClientSecretBasic: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              properties:
                response_type:
                  type: string
                client_id:
                  type: string
                redirect_uri:
                  type: string
                scope:
                  type: string
                state:
                  type: string
      responses:
        '201':
          description: PAR response
          content:
            application/json:
              schema:
                type: object
                properties:
                  request_uri:
                    type: string
                    example: urn:ietf:params:oauth:request_uri:6esc_11ACC5bwc014ltc14eY22c
                  expires_in:
                    type: integer
                    example: 90

  /introspect:
    post:
      tags:
        - OIDC Extensions
      summary: Token Introspection
      description: |
        Introspect access tokens or refresh tokens (RFC 7662).

        **Status**: ‚úÖ Implemented (Phase 4)
      operationId: introspect
      security:
        - ClientSecretBasic: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - token
              properties:
                token:
                  type: string
                token_type_hint:
                  type: string
                  enum: [access_token, refresh_token]
      responses:
        '200':
          description: Introspection response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IntrospectionResponse'

  /revoke:
    post:
      tags:
        - OIDC Extensions
      summary: Token Revocation
      description: |
        Revoke access tokens or refresh tokens (RFC 7009).

        **Status**: ‚úÖ Implemented (Phase 4)
      operationId: revoke
      security:
        - ClientSecretBasic: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - token
              properties:
                token:
                  type: string
                token_type_hint:
                  type: string
                  enum: [access_token, refresh_token]
      responses:
        '200':
          description: Token revoked successfully
        '400':
          description: Invalid request

  /auth/passkey/register:
    post:
      tags:
        - Authentication UI
      summary: Start Passkey Registration
      description: |
        Initiate WebAuthn/Passkey registration flow.

        **Status**: üìù Phase 5 Planned

        Returns WebAuthn challenge and options for navigator.credentials.create().
      operationId: passkeyRegister
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
                name:
                  type: string
      responses:
        '200':
          description: WebAuthn registration options
          content:
            application/json:
              schema:
                type: object
                properties:
                  challenge:
                    type: string
                  rp:
                    type: object
                  user:
                    type: object
                  pubKeyCredParams:
                    type: array
                    items:
                      type: object

  /auth/passkey/verify:
    post:
      tags:
        - Authentication UI
      summary: Verify Passkey Registration/Authentication
      description: |
        Verify WebAuthn credential and create session.

        **Status**: üìù Phase 5 Planned
      operationId: passkeyVerify
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - credential
              properties:
                credential:
                  type: object
                  description: WebAuthn credential from navigator.credentials.create/get()
      responses:
        '200':
          description: Authentication successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  session_id:
                    type: string
                  redirect_uri:
                    type: string

  /auth/magic-link/send:
    post:
      tags:
        - Authentication UI
      summary: Send Magic Link
      description: |
        Send magic link email for passwordless login.

        **Status**: üìù Phase 5 Planned

        **Rate limit**: 3 requests per 15 minutes per email
      operationId: magicLinkSend
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
                redirect_uri:
                  type: string
                  format: uri
      responses:
        '200':
          description: Magic link sent
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Magic link sent to user@example.com
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OAuthError'

  /auth/magic-link/verify:
    post:
      tags:
        - Authentication UI
      summary: Verify Magic Link Token
      description: |
        Verify magic link token and create session.

        **Status**: üìù Phase 5 Planned
      operationId: magicLinkVerify
      security: []
      parameters:
        - name: token
          in: query
          required: true
          schema:
            type: string
      responses:
        '302':
          description: Redirect to application
        '400':
          description: Invalid or expired token

  /auth/consent:
    get:
      tags:
        - Authentication UI
      summary: Get Consent Page Data
      description: |
        Retrieve data for OAuth consent page.

        **Status**: üìù Phase 5 Planned
      operationId: getConsent
      security: []
      parameters:
        - name: session_id
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Consent page data
          content:
            application/json:
              schema:
                type: object
                properties:
                  client:
                    $ref: '#/components/schemas/ClientInfo'
                  user:
                    $ref: '#/components/schemas/UserInfo'
                  scopes:
                    type: array
                    items:
                      type: object
                      properties:
                        scope:
                          type: string
                        description:
                          type: string

    post:
      tags:
        - Authentication UI
      summary: Submit Consent Decision
      description: |
        User grants or denies consent.

        **Status**: üìù Phase 5 Planned
      operationId: submitConsent
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - session_id
                - decision
              properties:
                session_id:
                  type: string
                decision:
                  type: string
                  enum: [allow, deny]
      responses:
        '302':
          description: Redirect to client callback

  /admin/users:
    get:
      tags:
        - Admin - Users
      summary: List Users
      description: |
        Get paginated list of users with search and filtering.

        **Status**: üìù Phase 5 Planned

        **Required permission**: users:read
      operationId: listUsers
      security:
        - BearerAuth: []
      parameters:
        - name: q
          in: query
          description: Search query (email, name)
          schema:
            type: string
        - name: filter
          in: query
          description: Filter by status
          schema:
            type: string
            enum: [verified, unverified, active, inactive]
        - name: sort
          in: query
          description: Sort field and order
          schema:
            type: string
            enum: [created_at, -created_at, last_login_at, -last_login_at, email, -email]
            default: -created_at
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            maximum: 100
      responses:
        '200':
          description: User list
          content:
            application/json:
              schema:
                type: object
                properties:
                  users:
                    type: array
                    items:
                      $ref: '#/components/schemas/User'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '401':
          description: Unauthorized
        '403':
          description: Insufficient permissions

    post:
      tags:
        - Admin - Users
      summary: Create User
      description: |
        Create a new user account.

        **Status**: üìù Phase 5 Planned

        **Required permission**: users:write
      operationId: createUser
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUserRequest'
      responses:
        '201':
          description: User created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          description: Invalid request
        '403':
          description: Insufficient permissions

  /admin/users/{id}:
    get:
      tags:
        - Admin - Users
      summary: Get User Details
      description: |
        Get detailed information about a specific user.

        **Status**: üìù Phase 5 Planned
      operationId: getUser
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: User details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserDetails'

    put:
      tags:
        - Admin - Users
      summary: Update User
      description: |
        Update user information.

        **Status**: üìù Phase 5 Planned

        **Required permission**: users:write
      operationId: updateUser
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserRequest'
      responses:
        '200':
          description: User updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

    delete:
      tags:
        - Admin - Users
      summary: Delete User
      description: |
        Permanently delete a user account.

        **Status**: üìù Phase 5 Planned

        **Required permission**: users:delete

        **Warning**: This action cannot be undone. All user data will be cascade deleted.
      operationId: deleteUser
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: User deleted
        '403':
          description: Insufficient permissions
        '404':
          description: User not found

  /admin/clients:
    get:
      tags:
        - Admin - Clients
      summary: List OAuth Clients
      description: |
        Get paginated list of OAuth clients.

        **Status**: üìù Phase 5 Planned
      operationId: listClients
      security:
        - BearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
      responses:
        '200':
          description: Client list
          content:
            application/json:
              schema:
                type: object
                properties:
                  clients:
                    type: array
                    items:
                      $ref: '#/components/schemas/OAuthClient'
                  pagination:
                    $ref: '#/components/schemas/Pagination'

    post:
      tags:
        - Admin - Clients
      summary: Create OAuth Client
      description: |
        Register a new OAuth client (extends DCR).

        **Status**: üìù Phase 5 Planned
      operationId: createClient
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClientRegistrationRequest'
      responses:
        '201':
          description: Client created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientRegistrationResponse'

  /admin/clients/{id}:
    put:
      tags:
        - Admin - Clients
      summary: Update OAuth Client
      description: |
        Update OAuth client configuration.

        **Status**: üìù Phase 5 Planned
      operationId: updateClient
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClientRegistrationRequest'
      responses:
        '200':
          description: Client updated

    delete:
      tags:
        - Admin - Clients
      summary: Delete OAuth Client
      description: |
        Delete an OAuth client.

        **Status**: üìù Phase 5 Planned
      operationId: deleteClient
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Client deleted

  /admin/stats:
    get:
      tags:
        - Admin - Stats
      summary: Get Statistics
      description: |
        Get system statistics and analytics.

        **Status**: üìù Phase 5 Planned
      operationId: getStats
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  users:
                    type: object
                    properties:
                      total:
                        type: integer
                      verified:
                        type: integer
                      active:
                        type: integer
                  sessions:
                    type: object
                    properties:
                      active:
                        type: integer
                  logins:
                    type: object
                    properties:
                      today:
                        type: integer
                      this_week:
                        type: integer
                  clients:
                    type: object
                    properties:
                      total:
                        type: integer

  /auth/session/token:
    post:
      tags:
        - Session Management
      summary: Issue Short-lived Session Token
      description: |
        Issue short-lived session token for ITP-compatible cross-domain SSO.

        **Status**: üìù Phase 5 Planned

        **TTL**: 5 minutes, single-use
      operationId: issueSessionToken
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - session_id
              properties:
                session_id:
                  type: string
      responses:
        '200':
          description: Session token issued
          content:
            application/json:
              schema:
                type: object
                properties:
                  session_token:
                    type: string
                  expires_in:
                    type: integer
                    example: 300

  /auth/session/verify:
    post:
      tags:
        - Session Management
      summary: Verify Session Token
      description: |
        Verify session token and establish RP session.

        **Status**: üìù Phase 5 Planned
      operationId: verifySessionToken
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - session_token
              properties:
                session_token:
                  type: string
      responses:
        '200':
          description: Session verified
          content:
            application/json:
              schema:
                type: object
                properties:
                  user_id:
                    type: string
                  session_id:
                    type: string

  /session/status:
    get:
      tags:
        - Session Management
      summary: Check Session Status
      description: |
        Check if IdP session is valid (iframe check_session_iframe alternative).

        **Status**: üìù Phase 5 Planned
      operationId: sessionStatus
      security: []
      parameters:
        - name: session_id
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Session status
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                  expires_at:
                    type: integer

  /session/refresh:
    post:
      tags:
        - Session Management
      summary: Refresh Session
      description: |
        Extend session TTL (Active TTL pattern).

        **Status**: üìù Phase 5 Planned
      operationId: refreshSession
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - session_id
              properties:
                session_id:
                  type: string
      responses:
        '200':
          description: Session refreshed
          content:
            application/json:
              schema:
                type: object
                properties:
                  expires_at:
                    type: integer

  /admin/sessions:
    get:
      tags:
        - Session Management
      summary: List Sessions (Admin)
      description: |
        List all active sessions (user/device breakdown).

        **Status**: üìù Phase 5 Planned
      operationId: listSessions
      security:
        - BearerAuth: []
      parameters:
        - name: user_id
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Session list
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    session_id:
                      type: string
                    user_id:
                      type: string
                    created_at:
                      type: integer
                    expires_at:
                      type: integer
                    ip_address:
                      type: string
                    user_agent:
                      type: string

  /admin/sessions/{id}/revoke:
    post:
      tags:
        - Session Management
      summary: Revoke Session (Admin)
      description: |
        Force logout a specific session.

        **Status**: üìù Phase 5 Planned
      operationId: revokeSession
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Session revoked

  /logout:
    get:
      tags:
        - Logout
      summary: Front-channel Logout
      description: |
        Browser-initiated logout (redirect flow).

        **Status**: üìù Phase 5 Planned
      operationId: logout
      security: []
      parameters:
        - name: id_token_hint
          in: query
          schema:
            type: string
        - name: post_logout_redirect_uri
          in: query
          schema:
            type: string
            format: uri
        - name: state
          in: query
          schema:
            type: string
      responses:
        '302':
          description: Redirect to post_logout_redirect_uri

  /logout/backchannel:
    post:
      tags:
        - Logout
      summary: Back-channel Logout
      description: |
        OP-initiated logout notification to RPs (RFC recommended).

        **Status**: üìù Phase 5 Planned

        **Note**: ITP-compatible, no iframe required.
      operationId: backchannelLogout
      security:
        - ClientSecretBasic: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - logout_token
              properties:
                logout_token:
                  type: string
                  description: JWT logout token
      responses:
        '200':
          description: Logout processed
        '400':
          description: Invalid logout token

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

    ClientSecretBasic:
      type: http
      scheme: basic
      description: Client ID and Secret via HTTP Basic Auth

    ClientSecretPost:
      type: apiKey
      in: header
      name: client_id
      description: Client credentials in request body

    OAuth2:
      type: oauth2
      flows:
        authorizationCode:
          authorizationUrl: /authorize
          tokenUrl: /token
          scopes:
            openid: OpenID Connect
            profile: User profile claims
            email: Email address
            address: Physical address
            phone: Phone number

  schemas:
    OIDCConfiguration:
      type: object
      properties:
        issuer:
          type: string
        authorization_endpoint:
          type: string
        token_endpoint:
          type: string
        userinfo_endpoint:
          type: string
        jwks_uri:
          type: string
        registration_endpoint:
          type: string
        scopes_supported:
          type: array
          items:
            type: string
        response_types_supported:
          type: array
          items:
            type: string
        grant_types_supported:
          type: array
          items:
            type: string
        subject_types_supported:
          type: array
          items:
            type: string

    JWKS:
      type: object
      properties:
        keys:
          type: array
          items:
            type: object
            properties:
              kty:
                type: string
              use:
                type: string
              kid:
                type: string
              n:
                type: string
              e:
                type: string

    AuthorizationCodeGrant:
      type: object
      required:
        - grant_type
        - code
        - redirect_uri
      properties:
        grant_type:
          type: string
          enum: [authorization_code]
        code:
          type: string
        redirect_uri:
          type: string
        code_verifier:
          type: string
          description: PKCE code verifier

    RefreshTokenGrant:
      type: object
      required:
        - grant_type
        - refresh_token
      properties:
        grant_type:
          type: string
          enum: [refresh_token]
        refresh_token:
          type: string
        scope:
          type: string

    TokenResponse:
      type: object
      properties:
        access_token:
          type: string
        token_type:
          type: string
          example: Bearer
        expires_in:
          type: integer
          example: 3600
        refresh_token:
          type: string
        id_token:
          type: string
        scope:
          type: string

    UserInfo:
      type: object
      properties:
        sub:
          type: string
        name:
          type: string
        given_name:
          type: string
        family_name:
          type: string
        email:
          type: string
        email_verified:
          type: boolean
        picture:
          type: string
        locale:
          type: string

    ClientRegistrationRequest:
      type: object
      required:
        - client_name
        - redirect_uris
      properties:
        client_name:
          type: string
        redirect_uris:
          type: array
          items:
            type: string
        grant_types:
          type: array
          items:
            type: string
        response_types:
          type: array
          items:
            type: string
        scope:
          type: string
        token_endpoint_auth_method:
          type: string
        logo_uri:
          type: string

    ClientRegistrationResponse:
      type: object
      properties:
        client_id:
          type: string
        client_secret:
          type: string
        client_name:
          type: string
        redirect_uris:
          type: array
          items:
            type: string
        client_id_issued_at:
          type: integer
        client_secret_expires_at:
          type: integer

    IntrospectionResponse:
      type: object
      properties:
        active:
          type: boolean
        scope:
          type: string
        client_id:
          type: string
        username:
          type: string
        token_type:
          type: string
        exp:
          type: integer
        iat:
          type: integer
        sub:
          type: string

    User:
      type: object
      properties:
        id:
          type: string
        email:
          type: string
        email_verified:
          type: boolean
        name:
          type: string
        created_at:
          type: integer
        last_login_at:
          type: integer

    UserDetails:
      allOf:
        - $ref: '#/components/schemas/User'
        - type: object
          properties:
            passkeys:
              type: array
              items:
                type: object
            sessions:
              type: array
              items:
                type: object
            roles:
              type: array
              items:
                type: string

    CreateUserRequest:
      type: object
      required:
        - email
      properties:
        email:
          type: string
          format: email
        name:
          type: string
        email_verified:
          type: boolean
          default: false

    UpdateUserRequest:
      type: object
      properties:
        email:
          type: string
        name:
          type: string
        email_verified:
          type: boolean

    OAuthClient:
      type: object
      properties:
        client_id:
          type: string
        client_name:
          type: string
        redirect_uris:
          type: array
          items:
            type: string
        created_at:
          type: integer

    ClientInfo:
      type: object
      properties:
        client_id:
          type: string
        client_name:
          type: string
        logo_uri:
          type: string
        policy_uri:
          type: string
        tos_uri:
          type: string

    Pagination:
      type: object
      properties:
        page:
          type: integer
        limit:
          type: integer
        total:
          type: integer
        total_pages:
          type: integer

    OAuthError:
      type: object
      properties:
        error:
          type: string
          example: invalid_request
        error_description:
          type: string
          example: The request is missing a required parameter
        error_uri:
          type: string
          example: https://docs.enrai.org/errors/invalid_request
