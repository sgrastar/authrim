# UserInfo Endpoint 負荷テストレポート

**実施日**: 2025年12月12日
**テスト対象**: Authrim OIDC Provider - UserInfo Endpoint (`/userinfo`)
**テストツール**: K6 Cloud (分散負荷テスト)
**監視ツール**: Cloudflare Analytics API

---

## 1. テスト概要

### 1.1 テスト目的

UserInfo エンドポイントの最大スループットと性能限界を測定し、Bearer トークン認証のパフォーマンスを評価する。

### 1.2 テスト対象エンドポイント

```
GET /userinfo
Authorization: Bearer {access_token}
```

### 1.3 テスト特性

| 項目 | 内容 |
|------|------|
| **認証方式** | Bearer Token (JWT) |
| **成功判定** | HTTP 200 + `sub` クレーム存在 |
| **トークン** | 事前生成済み有効トークン4,000件 |
| **JWT検証** | RS256署名検証（JWKキャッシュあり） |

### 1.4 テスト環境

| コンポーネント | 詳細 |
|----------------|------|
| **ターゲット** | https://conformance.authrim.com |
| **負荷発生** | K6 Cloud (amazon:us:portland) |
| **インフラ** | Cloudflare Workers + Durable Objects + D1 |
| **トークン数** | 4,000件（R2から取得） |
| **テスト時間** | ウォームアップ30s + 本測定3分30s |

---

## 2. テスト結果サマリー

### 2.1 RPS別パフォーマンス比較表

| RPS | K6総リクエスト | CF総リクエスト | K6失敗 | CF Worker エラー | CF DO エラー | 判定 |
|----:|---------------:|---------------:|-------:|-----------------:|-------------:|:----:|
| 1,000 | 146,231 | 146,231 | 0 | 0 | 0 | ✅ |
| 2,000 | 293,947 | 293,947 | 0 | 0 | 0 | ✅ |
| 2,500 | 365,648 | 365,648 | 0 | 0 | 0 | ⚠️ |
| 3,000 | 436,456 | 436,456 | 0 | 0 | 0 | ⚠️ |

> **注**: K6 Threshold超過は ⚠️ で表示。全RPSでHTTPエラー0%を達成。

---

## 3. K6 Cloud クライアント側メトリクス

### 3.1 HTTP リクエスト Duration (ms) - Benchmark シナリオ

K6クライアント側で計測した、リクエスト発行からレスポンス受信までの時間（ネットワーク往復含む）：

| RPS | 総リクエスト | p50 (median) | mean | p95 | p99 | max |
|----:|-------------:|-------------:|-----:|----:|----:|----:|
| 1,000 | 144,720 | 114 | 117 | 139 | 200 | 4,523 |
| 2,000 | 292,447 | 118 | 133 | 254 | 350 | 29,717 |
| 2,500 | 364,147 | 127 | 174 | 325 | 585 | 5,842 |
| 3,000 | 434,955 | 150 | 298 | 1,032 | 1,736 | 5,462 |

> **計測ポイント**: K6クライアント（USオレゴン）からCloudflare Edgeまでの往復時間を含む

### 3.2 HTTPリクエスト失敗率

| RPS | 総リクエスト | 失敗数 | 失敗率 |
|----:|-------------:|-------:|-------:|
| 1,000 | 144,720 | 0 | 0.0000% |
| 2,000 | 292,447 | 0 | 0.0000% |
| 2,500 | 364,147 | 0 | 0.0000% |
| 3,000 | 434,955 | 0 | 0.0000% |

> **全RPS帯で失敗率0%を達成**

### 3.3 Warmup シナリオ Duration (ms)

ウォームアップ期間（30秒、50 RPS）の指標：

| RPS | リクエスト数 | p50 (median) | mean | p95 | p99 |
|----:|-------------:|-------------:|-----:|----:|----:|
| 1,000 | 約1,500 | 112 | 112 | 133 | 138 |
| 2,000 | 約1,500 | 111 | 114 | 134 | 138 |
| 2,500 | 約1,500 | 112 | 118 | 135 | 488 |
| 3,000 | 約1,500 | 112 | 115 | 135 | 155 |

> **ウォームアップでDOがアクティブ化され、本測定時の初期スパイクを防止**

---

## 4. Cloudflare サーバー側メトリクス

### 4.1 Cloudflare Worker Duration (ms)

サーバー側（Cloudflare Worker）で計測した処理時間：

| RPS | Total | p50 | p75 | p90 | p99 | p999 |
|----:|------:|----:|----:|----:|----:|-----:|
| 1,000 | 146,231 | 13.22 | 14.14 | 15.62 | 31.20 | 88.22 |
| 2,000 | 293,947 | 14.11 | 16.57 | 24.15 | 44.54 | 176.35 |
| 2,500 | 365,648 | 15.99 | 27.52 | 55.91 | 178.63 | 668.57 |
| 3,000 | 436,456 | 17.58 | 50.69 | 124.55 | 231.23 | 596.17 |

### 4.2 Cloudflare Worker CPU Time (ms)

Worker内の実際のCPU処理時間（JWT検証含む）：

| RPS | p50 | p75 | p90 | p99 | p999 |
|----:|----:|----:|----:|----:|-----:|
| 1,000 | 1.10 | 1.23 | 1.50 | 4.02 | 5.28 |
| 2,000 | 1.07 | 1.18 | 1.42 | 3.96 | 4.81 |
| 2,500 | 1.06 | 1.17 | 1.43 | 3.97 | 4.85 |
| 3,000 | 1.05 | 1.17 | 1.44 | 3.98 | 4.92 |

> **重要**: CPU時間は全RPS帯で安定（p99 ~4ms）。JWT RS256検証のオーバーヘッドは最小限。

### 4.3 Cloudflare Durable Objects Wall Time (ms)

KeyManager DO（JWK取得・キャッシュ）の処理時間：

| RPS | Total DO Req | DO Errors | p50 | p75 | p90 | p99 | p999 |
|----:|-------------:|----------:|----:|----:|----:|----:|-----:|
| 1,000 | 146,324 | 0 | 0.82 | 1.87 | 3.38 | 7.83 | 89.34 |
| 2,000 | 294,023 | 0 | 0.46 | 0.74 | 1.63 | 6.87 | 40.59 |
| 2,500 | 352,388 | 0 | 0.40 | 0.58 | 1.19 | 5.41 | 39.51 |
| 3,000 | 366,986 | 0 | 0.38 | 0.54 | 0.94 | 6.07 | 58.62 |

> **特徴**: 高RPS時ほどDO Wall Timeが改善（キャッシュヒット率向上）

### 4.4 D1 データベースメトリクス

| RPS | Read Queries | Write Queries | Rows Read | Rows Written |
|----:|-------------:|--------------:|----------:|-------------:|
| 1,000 | 525,433 | 341,182 | 470,091 | 1,982,394 |
| 2,000 | 525,821 | 341,182 | 470,479 | 1,982,394 |
| 2,500 | 529,698 | 341,182 | 474,356 | 1,982,394 |
| 3,000 | 528,988 | 341,182 | 473,646 | 1,982,394 |

> **注**: Write Queriesが一定なのは、ユーザー情報キャッシュ（USER_CACHE KV）が有効なため

---

## 5. テスト実行情報

### 5.1 K6 Cloud テストURL

| RPS | K6 Cloud URL | 実行時刻 (JST) |
|----:|--------------|----------------|
| 1,000 | https://authrim.grafana.net/a/k6-app/runs/6301049 | 01:08 |
| 2,000 | *(結果保存済み)* | 01:20 |
| 2,500 | https://authrim.grafana.net/a/k6-app/runs/6301165 | 01:40 |
| 3,000 | https://authrim.grafana.net/a/k6-app/runs/6301118 | 01:30 |

### 5.2 Cloudflare Analytics 取得期間 (UTC)

| RPS | 開始 | 終了 |
|----:|------|------|
| 1,000 | 2025-12-11T16:01:00Z | 2025-12-11T16:07:00Z |
| 2,000 | 2025-12-11T16:13:00Z | 2025-12-11T16:21:00Z |
| 2,500 | 2025-12-11T16:36:00Z | 2025-12-11T16:42:00Z |
| 3,000 | 2025-12-11T16:27:00Z | 2025-12-11T16:33:00Z |

### 5.3 テスト設定

```javascript
// K6 Cloud プリセット例 (2000 RPS)
{
  scenarios: {
    warmup: {
      executor: 'constant-arrival-rate',
      rate: 50,
      duration: '30s',
      exec: 'warmupScenario',
    },
    userinfo_benchmark: {
      executor: 'ramping-arrival-rate',
      startRate: 0,
      timeUnit: '1s',
      preAllocatedVUs: 2400,
      maxVUs: 3000,
      stages: [
        { target: 1000, duration: '15s' },  // ramp-up
        { target: 2000, duration: '180s' }, // 維持
        { target: 0, duration: '15s' },     // ramp-down
      ],
      startTime: '30s',
    },
  },
}
```

---

## 6. 分析と考察

### 6.1 パフォーマンス傾向

```
RPS vs K6 Client Duration (median)
────────────────────────────────────────────
1000  ████████████████ 114ms           ✅ 良好
2000  ████████████████ 118ms           ✅ 良好
2500  █████████████████ 127ms          ⚠️ 微増
3000  ████████████████████ 150ms       ❌ 限界
────────────────────────────────────────────

RPS vs K6 Client Duration (p99)
────────────────────────────────────────────
1000  ███ 200ms                        ✅ 良好
2000  █████ 350ms                      ✅ 許容範囲
2500  █████████ 585ms                  ⚠️ 高め
3000  ██████████████████████████ 1,736ms  ❌ 限界超過
────────────────────────────────────────────

RPS vs CF Worker Duration (p99)
────────────────────────────────────────────
1000  ██ 31ms                          ✅ 良好
2000  ████ 45ms                        ✅ 良好
2500  █████████████████████ 179ms      ⚠️ 急上昇
3000  ██████████████████████████ 231ms ❌ 限界
────────────────────────────────────────────
```

### 6.2 ボトルネック分析

| レイヤー | 1000-2000 RPS | 2500 RPS | 3000 RPS |
|---------|--------------|----------|----------|
| **K6 Client p99** | 200-350ms | 585ms | 1,736ms |
| **Worker CPU** | 安定 (1-4ms) | 安定 (1-4ms) | 安定 (1-4ms) |
| **Worker Duration** | 安定 (15-45ms) | 急上昇 (55-179ms) | 限界 (125-231ms) |
| **DO Wall Time** | 安定 (1-8ms) | 安定 (1-5ms) | 安定 (1-6ms) |
| **判定** | 余裕あり | 負荷限界 | 性能劣化 |

### 6.3 主要な発見

1. **JWT検証は高速**: CPU時間は全RPSで1-4ms程度で安定（V8 WebCrypto + JWKキャッシュ効果）
2. **DO (KeyManager) は超高速**: Wall Time p99が5-8msで安定
3. **ボトルネックはWorker Duration**: 高RPS時のリクエストキューイングが主因
4. **キャッシュが有効**: USER_CACHE KVによりD1 Writeが一定
5. **全RPS帯で失敗率0%**: HTTPエラーは発生せず、信頼性は高い

### 6.4 Silent Auth との比較

| エンドポイント | 推奨運用 | ピーク対応 | 限界値 |
|---------------|---------|-----------|--------|
| **Silent Auth** | 2,000 RPS | 3,000 RPS | 4,000 RPS |
| **UserInfo** | 2,000 RPS | 2,500 RPS | 3,000 RPS |

> UserInfoはSilent Authより低いスループット。理由: JWT検証 + D1読み込みのオーバーヘッド

### 6.5 負荷増加時の劣化パターン

```
2500 RPS以降の性能劣化（K6 median duration推移）：

Time   1000 RPS    2000 RPS    2500 RPS    3000 RPS
────────────────────────────────────────────────────
安定期  ~114ms      ~115ms      ~127ms      ~150ms
後半    ~114ms      ~177ms      ~313ms      ~573ms
終了時  ~114ms      ~111ms      ~112ms      ~113ms

→ 高RPS時は時間経過とともにキューイングが蓄積
→ Ramp-down後は即座に正常化
```

---

## 7. 推奨運用値

| 用途 | 推奨RPS | 根拠 |
|------|---------|------|
| **通常運用** | 〜2,000 RPS | K6 p99 < 350ms、CF p99 < 50ms、エラー0% |
| **ピーク対応** | 〜2,500 RPS | K6 p99 < 600ms、CF p99 < 200ms、エラー0% |
| **絶対上限** | 〜3,000 RPS | K6 p99 < 2000ms、CF p99 < 250ms、DOエラー0% |

---

## 8. データ保存場所

各テストの詳細データは以下に保存：

```
/Users/yuta/Downloads/
├── userinfo-us-1000rps-20251212-0108/
├── userinfo-us-2000rps-20251212-0120/
├── userinfo-us-2500rps-20251212-0140/
└── userinfo-us-3000rps-20251212-0130/
    ├── k6-output.log           # K6 Cloud実行ログ
    ├── cf-analytics.txt        # Cloudflare Analyticsレポート
    ├── metric_http_req_duration.csv  # HTTPリクエスト時間
    ├── metric_http_req_failed.csv    # HTTPリクエスト失敗
    └── metric_userinfo_success.csv   # UserInfo成功率
```

---

## 9. 結論

### 9.1 性能評価

| 項目 | 結果 |
|------|------|
| **最大スループット** | 3,000 RPS (エラー0%) |
| **推奨運用** | 2,000 RPS (K6 p99 < 350ms) |
| **ピーク対応** | 2,500 RPS (K6 p99 < 600ms) |

### 9.2 アーキテクチャ効果

| 最適化 | 効果 |
|--------|------|
| **JWKキャッシュ (DO)** | JWT検証が高速化（p99 4ms） |
| **USER_CACHE (KV)** | D1読み込み削減、Write一定 |
| **Read-Through Pattern** | キャッシュヒット時は超高速 |
| **Warmupシナリオ** | コールドスタートスパイク防止 |

### 9.3 総評

Authrim OIDC Provider の UserInfo エンドポイントは：

- **2,000 RPSまで**: 高品質なレスポンス（K6 p99 < 350ms、CF p99 < 50ms）
- **2,500 RPSまで**: 許容範囲内（K6 p99 < 600ms、CF p99 < 200ms）
- **3,000 RPS以上**: 性能劣化が顕著（K6 p99 > 1700ms）

**DO (Durable Objects) は高速**であり、ボトルネックは **Cloudflare Workers のリクエストキューイング** にあることが確認されました。更なるスケールアウトには、マルチリージョン展開やWorker分散が必要です。

**全テストで失敗率0%を達成**しており、スループット限界に達しても信頼性は維持されています。

---

*レポート作成: Claude Code*
*テスト実施: 2025-12-12*
