# 負荷テスト結果レポート (2025-12-10)

## 概要

OIDC認証フロー（test-session作成 → authorize → token交換）の負荷テストを実施。
100RPS、150RPS、200RPSの3段階でパフォーマンスを測定。

**テスト対象:** https://conformance.authrim.com

**テスト日時:** 2025-12-10 21:43 - 21:55 JST (12:43 - 12:55 UTC)

---

## 結果サマリー

### 認証フロー全体 (E2E) レイテンシ比較

| 指標 | 100 RPS | 150 RPS | 200 RPS |
|------|---------|---------|---------|
| **平均** | 2,685 ms | 4,186 ms | 5,145 ms |
| **p50** | 2,593 ms | 4,217 ms | 5,311 ms |
| **p95** | 4,168 ms | 6,126 ms | 7,062 ms |
| **p99** | 4,723 ms | 6,677 ms | 8,071 ms |
| **p99.9** | 5,307 ms | 7,191 ms | 9,006 ms |
| **max** | 6,502 ms | 7,683 ms | 9,475 ms |
| **成功率** | 99.92% | 99.97% | 99.88% |

### 各ステップ別レイテンシ (p50)

| ステップ | 100 RPS | 150 RPS | 200 RPS |
|----------|---------|---------|---------|
| セッション作成 | 681 ms | 1,602 ms | 2,249 ms |
| 認可コード取得 | 1,403 ms | 2,115 ms | 2,508 ms |
| トークン交換 | 379 ms | 369 ms | 365 ms |

### 各ステップ別レイテンシ (p99)

| ステップ | 100 RPS | 150 RPS | 200 RPS |
|----------|---------|---------|---------|
| セッション作成 | 1,823 ms | 2,937 ms | 3,683 ms |
| 認可コード取得 | 2,799 ms | 3,875 ms | 4,420 ms |
| トークン交換 | 917 ms | 925 ms | 902 ms |

---

## Cloudflare メトリクス

### Worker Duration (実行時間)

| 指標 | 100 RPS | 150 RPS | 200 RPS |
|------|---------|---------|---------|
| p50 | 172.70 ms | 265.51 ms | 312.17 ms |
| p75 | 221.35 ms | 324.62 ms | 395.31 ms |
| p90 | 265.92 ms | 389.48 ms | 452.55 ms |
| p99 | 346.45 ms | 482.69 ms | 551.34 ms |
| p999 | 411.01 ms | 547.21 ms | 644.12 ms |

### Worker CPU Time

| 指標 | 100 RPS | 150 RPS | 200 RPS |
|------|---------|---------|---------|
| p50 | 5.52 ms | 5.43 ms | 5.36 ms |
| p75 | 7.06 ms | 6.92 ms | 6.83 ms |
| p90 | 8.06 ms | 8.07 ms | 8.08 ms |
| p99 | 15.94 ms | 16.03 ms | 16.37 ms |
| p999 | 20.69 ms | 31.90 ms | 36.15 ms |

### Durable Objects Wall Time

| 指標 | 100 RPS | 150 RPS | 200 RPS |
|------|---------|---------|---------|
| p50 | 59.62 ms | 29.18 ms | 24.23 ms |
| p75 | 190.75 ms | 158.32 ms | 102.48 ms |
| p90 | 498.31 ms | 518.55 ms | 472.65 ms |
| p99 | 1,690 ms | 1,514 ms | 1,308 ms |
| p999 | 3,224 ms | 2,834 ms | 2,335 ms |

### リクエスト統計

| 指標 | 100 RPS | 150 RPS | 200 RPS |
|------|---------|---------|---------|
| 総リクエスト数 | 12,247 | 13,494 | 16,406 |
| サブリクエスト数 | 36,745 | 40,493 | 49,213 |
| DOリクエスト数 | 44,494 | 49,104 | 57,780 |
| エラー数 | 0 | 0 | 0 |
| エラー率 | 0.00% | 0.00% | 0.00% |

### D1 データベース統計

| 指標 | 100 RPS | 150 RPS | 200 RPS |
|------|---------|---------|---------|
| Read Queries | 233,113 | 254,106 | 254,106* |
| Write Queries | 174,900 | 212,620 | 212,620* |
| Rows Read | 242,137 | 278,911 | 278,911* |
| Rows Written | 971,460 | 1,181,518 | 1,181,518* |

*注: D1の統計は日次集計のため、同日の累計値を含む

---

## テスト詳細

### 100 RPS テスト

- **プリセット:** rps100 (100 RPS - Medium load 90s)
- **実行期間:** 2025-12-10T12:44:35Z - 12:47:03Z (約2分30秒)
- **完了イテレーション:** 約6,100 フロー
- **成功率:** 99.92%
- **エラー内訳:**
  - session_errors: 3
  - authorize_errors: 2
  - server_errors: 5

### 150 RPS テスト

- **プリセット:** rps150 (150 RPS - Medium-high load 90s)
- **実行期間:** 2025-12-10T12:48:40Z - 12:51:05Z (約2分25秒)
- **完了イテレーション:** 約6,700 フロー
- **成功率:** 99.97%
- **エラー内訳:**
  - authorize_errors: 2
  - server_errors: 2

### 200 RPS テスト

- **プリセット:** rps200 (200 RPS - High load 90s)
- **実行期間:** 2025-12-10T12:52:31Z - 12:55:04Z (約2分30秒)
- **完了イテレーション:** 約8,200 フロー
- **成功率:** 99.88%
- **エラー内訳:**
  - session_errors: 3
  - authorize_errors: 7
  - server_errors: 10

---

## 分析

### レイテンシ傾向

```
認証フロー全体 p50 (ms)
200 RPS: ████████████████████████████████████████████████████████ 5311
150 RPS: ██████████████████████████████████████████ 4217
100 RPS: ██████████████████████████ 2593

認証フロー全体 p99 (ms)
200 RPS: ████████████████████████████████████████████████████████████████████████████████ 8071
150 RPS: ██████████████████████████████████████████████████████████████████ 6677
100 RPS: ███████████████████████████████████████████████ 4723
```

### 主な所見

1. **スケーラビリティ:**
   - RPSが増加するにつれてレイテンシは線形以上に増加
   - 100→150 RPS: p50で+62%増加
   - 150→200 RPS: p50で+26%増加

2. **ボトルネック分析:**
   - セッション作成とauthorizeが主要なボトルネック
   - トークン交換は負荷に関係なく安定（p50: 365-379ms）
   - CPU Timeは負荷に関係なくほぼ一定（p50: 5.4-5.5ms）

3. **エラー率:**
   - 全テストで99.88%以上の成功率を維持
   - 200RPSでも安定して動作

4. **Durable Objects:**
   - 高負荷時にp99/p999が改善（ウォーミングアップ効果）
   - キャッシュヒット率の向上が示唆される

5. **Workerエラー:**
   - Cloudflare側でのエラーは0%
   - k6側のエラーはネットワーク関連の一時的な問題

---

## 推奨事項

1. **100 RPS以下:** 本番環境での安定運用ライン
   - p99 < 5秒、成功率99.9%+

2. **150 RPS:** 中程度の負荷でも安定
   - p99 < 7秒、一部ユーザー体験に影響の可能性

3. **200 RPS:** 高負荷シナリオ
   - p99 > 8秒、ユーザー体験への影響あり
   - セッション作成・認可フローの最適化を検討

### 改善候補

- セッション作成の最適化（Durable Object呼び出しの削減）
- 認可フローのキャッシング強化
- D1クエリの最適化

---

## テスト環境

- **k6バージョン:** v0.55.0
- **テストスクリプト:** `load-testing/scripts/test-auth-flow.js`
- **ユーザープール:** 499,947ユーザー
- **テスト実行元:** ローカルマシン (macOS Darwin 24.6.0)

---

## 関連ファイル

- k6 結果ログ: `/tmp/k6_*_result.txt`
- CF Analytics: `load-testing/results/cf-analytics_2025-12-10T*.json`
- テストスクリプト: `load-testing/scripts/test-auth-flow.js`

---

# 第2回テスト: シャード数増加 (2025-12-10 23:00 JST)

## シャード設定変更

| 項目 | 変更前 | 変更後 |
|------|--------|--------|
| **Authorization Code Shards** | 32 | **64** |
| **Session Shards** | 32 | **64** |
| **Refresh Token Shards** | 6 | **8** |

**テスト日時:** 2025-12-10 23:03 - 23:19 JST (14:03 - 14:19 UTC)

---

## 結果サマリー（シャード 64/64/8）

### 認証フロー全体 (E2E) レイテンシ比較

| 指標 | 100 RPS | 150 RPS | 200 RPS |
|------|---------|---------|---------|
| **平均** | 2,747 ms | 3,904 ms | 5,528 ms |
| **p50** | 2,900 ms | 3,965 ms | 5,652 ms |
| **p95** | 4,064 ms | 5,633 ms | 7,789 ms |
| **p99** | 4,561 ms | 6,264 ms | 8,353 ms |
| **p99.9** | 5,224 ms | 6,893 ms | 8,961 ms |
| **max** | 6,289 ms | 8,360 ms | 9,133 ms |
| **成功率** | 99.98% | 99.94% | 99.95% |

### 各ステップ別レイテンシ (p50)

| ステップ | 100 RPS | 150 RPS | 200 RPS |
|----------|---------|---------|---------|
| セッション作成 | 913 ms | 1,436 ms | 2,497 ms |
| 認可コード取得 | 1,482 ms | 2,032 ms | 2,625 ms |
| トークン交換 | 365 ms | 359 ms | 361 ms |

### 各ステップ別レイテンシ (p99)

| ステップ | 100 RPS | 150 RPS | 200 RPS |
|----------|---------|---------|---------|
| セッション作成 | 1,609 ms | 2,590 ms | 3,746 ms |
| 認可コード取得 | 2,718 ms | 3,545 ms | 4,725 ms |
| トークン交換 | 1,026 ms | 1,059 ms | 1,212 ms |

---

## Cloudflare メトリクス（シャード 64/64/8）

### Worker Duration (実行時間)

| 指標 | 100 RPS | 150 RPS | 200 RPS |
|------|---------|---------|---------|
| p50 | 184.43 ms | 252.28 ms | 327.33 ms |
| p75 | 239.32 ms | 299.82 ms | 422.97 ms |
| p90 | 267.33 ms | 350.61 ms | 502.59 ms |
| p99 | 338.16 ms | 439.13 ms | 594.32 ms |
| p999 | 403.71 ms | 521.36 ms | 660.53 ms |

### Worker CPU Time

| 指標 | 100 RPS | 150 RPS | 200 RPS |
|------|---------|---------|---------|
| p50 | 5.39 ms | 5.34 ms | 5.33 ms |
| p75 | 6.90 ms | 6.67 ms | 6.68 ms |
| p90 | 7.92 ms | 7.79 ms | 7.88 ms |
| p99 | 15.95 ms | 15.79 ms | 15.50 ms |
| p999 | 20.18 ms | 32.62 ms | 36.78 ms |

### Durable Objects Wall Time

| 指標 | 100 RPS | 150 RPS | 200 RPS |
|------|---------|---------|---------|
| p50 | 63.56 ms | 51.74 ms | 42.94 ms |
| p75 | 335.65 ms | 327.72 ms | 330.04 ms |
| p90 | 952.06 ms | 831.93 ms | 955.12 ms |
| p99 | 3,717 ms | 2,940 ms | 3,021 ms |
| p999 | 7,667 ms | 5,959 ms | 5,328 ms |

### リクエスト統計

| 指標 | 100 RPS | 150 RPS | 200 RPS |
|------|---------|---------|---------|
| 総リクエスト数 | 12,732 | 14,683 | 15,321 |
| サブリクエスト数 | 38,204 | 44,055 | 45,964 |
| DOリクエスト数 | 44,452 | 51,908 | 53,618 |
| エラー数 | 0 | 0 | 0 |
| エラー率 | 0.00% | 0.00% | 0.00% |

---

## テスト詳細（シャード 64/64/8）

### 100 RPS テスト

- **実行期間:** 2025-12-10T14:03:10Z - 14:05:38Z (約2分30秒)
- **完了イテレーション:** 6,368 フロー
- **成功率:** 99.98%
- **エラー内訳:**
  - authorize_errors: 1
  - server_errors: 1

### 150 RPS テスト

- **実行期間:** 2025-12-10T14:08:22Z - 14:10:45Z (約2分25秒)
- **完了イテレーション:** 7,842 フロー
- **成功率:** 99.94%
- **エラー内訳:**
  - session_errors: 1
  - authorize_errors: 4
  - server_errors: 5

### 200 RPS テスト

- **実行期間:** 2025-12-10T14:16:17Z - 14:19:08Z (約2分50秒)
- **完了イテレーション:** 7,683 フロー
- **成功率:** 99.95%
- **エラー内訳:**
  - session_errors: 2
  - authorize_errors: 2
  - server_errors: 4

---

## シャード増加の効果比較

### 認証フロー全体 p50 比較

| RPS | シャード 32/32/6 | シャード 64/64/8 | 差分 |
|-----|------------------|------------------|------|
| 100 | 2,593 ms | 2,900 ms | +307 ms (+12%) |
| 150 | 4,217 ms | 3,965 ms | **-252 ms (-6%)** |
| 200 | 5,311 ms | 5,652 ms | +341 ms (+6%) |

### 認証フロー全体 p99 比較

| RPS | シャード 32/32/6 | シャード 64/64/8 | 差分 |
|-----|------------------|------------------|------|
| 100 | 4,723 ms | 4,561 ms | **-162 ms (-3%)** |
| 150 | 6,677 ms | 6,264 ms | **-413 ms (-6%)** |
| 200 | 8,071 ms | 8,353 ms | +282 ms (+3%) |

### 成功率比較

| RPS | シャード 32/32/6 | シャード 64/64/8 |
|-----|------------------|------------------|
| 100 | 99.92% | 99.98% |
| 150 | 99.97% | 99.94% |
| 200 | 99.88% | 99.95% |

---

## 分析（シャード増加テスト）

### 主な所見

1. **150 RPSで最も効果的:**
   - p50: -252ms (-6%)、p99: -413ms (-6%)の改善
   - シャード増加による負荷分散効果が最も発揮される領域

2. **100 RPSでは微増:**
   - シャード数の増加によるオーバーヘッドが発生
   - 低負荷時はシャード分散のコストが上回る

3. **200 RPSでは混在:**
   - p50は若干悪化、p99もわずかに悪化
   - この負荷レベルでは他のボトルネック（D1等）が支配的

4. **DO Wall Time:**
   - p99/p999は全般的に悪化傾向
   - シャード数増加によるDO間の同期オーバーヘッド増

5. **成功率:**
   - 100RPSと200RPSで改善
   - エラー数が減少し、より安定した動作

### 結論

- **推奨設定:** 150 RPS前後の負荷が想定される場合はシャード64/64/8が効果的
- **低負荷時（100 RPS以下）:** シャード32/32/6の方が若干効率的
- **高負荷時（200 RPS）:** シャード数増加だけでは限界があり、他の最適化が必要
