# Auth Flow 負荷テスト結果サマリー

**テスト日時**: 2025-12-09 12:05-12:17 JST
**テスト環境**: conformance.authrim.com
**テストスクリプト**: `scripts/test-auth-flow.js`

---

## テスト概要

| 項目 | 値 |
|------|-----|
| プリセット | `rps50` (50 RPS - Light load) |
| テスト時間 | 80秒 (10s ramp-up → 60s sustained → 10s ramp-down) |
| 最大VU数 | 100 |
| テスト回数 | 4回 |

### テストフロー
1. **Session作成** - `POST /api/admin/test-sessions`
2. **認可コード取得** - `GET /authorize` (PKCE)
3. **トークン交換** - `POST /token`

---

## 測定結果

### フロー全体

| 回 | 平均 | 中央値 | p95 | 成功率 | エラー |
|----|------|--------|-----|--------|--------|
| 1回目 | 5,128ms | 5,510ms | 6,667ms | 99.77% | 4 |
| 2回目 | 5,181ms | 5,545ms | 6,453ms | 100.00% | 0 |
| 3回目 | 5,066ms | 5,428ms | 6,316ms | 99.78% | 4 |
| 4回目 | 5,174ms | 5,628ms | 6,723ms | 99.92% | 2 |
| **平均** | **5,137ms** | **5,528ms** | **6,540ms** | **99.87%** | **2.5** |

### ステップ別内訳（4回目の結果）

| ステップ | 平均 | p95 |
|----------|------|-----|
| Session作成 | 1,989ms | 2,825ms |
| 認可コード取得 | 1,753ms | 2,755ms |
| トークン交換 | 1,433ms | 2,084ms |

---

## 設定値

### シャーディング

| 設定 | 値 |
|------|-----|
| `session_shards` | 12 |
| `code_shards` | 12 |

### Cloudflare Workers

| 設定 | 値 |
|------|-----|
| Smart Placement | 有効 (`mode = "smart"`) |
| Durable Objects | 13種類 |

---

## 過去の測定との比較

| 時期 | シャード数 | 平均レイテンシ | 成功率 |
|------|-----------|---------------|--------|
| 2025-12-08 (前回) | 12 | ~3,040ms | ~99% |
| **2025-12-09 (今回)** | **12** | **~5,137ms** | **~99.9%** |

### 差異の考察

前回と今回で約70%のレイテンシ増加が見られる。考えられる要因：

1. **データ量の増加** - D1/DOに蓄積されたデータ量の影響
2. **Cloudflareインフラの変動** - エッジロケーションの負荷状況
3. **DOのコールドスタート状態** - 前回はウォームアップ後の測定だった可能性
4. **テスト条件の違い** - 前回セッションの測定条件が異なっていた可能性

---

## シャード数別パフォーマンス比較（過去の測定）

| シャード数 | Full flow avg | p95 | 成功率 | エラー |
|-----------|---------------|-----|--------|--------|
| 16 | 5,002ms | 6,225ms | 98.90% | 15 |
| **12** | **~3,040ms** | **~4,400ms** | **~99%** | **~3** |
| 8 | 3,408ms | 5,132ms | 91.52% | 38 |
| 6 | 3,299ms | 4,735ms | 92.61% | 36 |

**結論**: 12シャードが成功率とレイテンシのバランスで最適

---

## エラー分類

| エラー種別 | 発生数（4回合計） |
|-----------|------------------|
| authorize_errors | 3 |
| token_errors | 2 |
| server_errors | 2 |
| session_errors | 0 |
| rate_limit_errors | 0 |

---

## 推奨事項

1. **現在の設定を維持** - 12シャード設定で成功率99.9%を維持
2. **定期的な測定** - レイテンシ変動を監視するため週次で測定推奨
3. **スケールアップ検討** - 100+ RPS対応時はシャード数増加を検討

---

## テストコマンド

```bash
k6 run scripts/test-auth-flow.js \
  --env PRESET=rps50 \
  --env CLIENT_ID=b42bdc5e-7183-46ef-859c-fd21d4589cd6 \
  --env CLIENT_SECRET=6ec3c4aed67c40d9ae8891e4641292ae15cf215264ba4618b7c89356b54b0bde \
  --env ADMIN_API_SECRET=production-secret-change-me
```

---

## 添付

- テストスクリプト: `load-testing/scripts/test-auth-flow.js`
- シード設定スクリプト: `scripts/setup-kv.sh`
