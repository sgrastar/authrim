# Cloudflare Workers Analytics Query
# Usage: wrangler graphql --account-id $CLOUDFLARE_ACCOUNT_ID --query-file queries/worker_stats.graphql

query WorkerAnalytics(
  $accountTag: string!
  $scriptName: string!
  $datetimeStart: string!
  $datetimeEnd: string!
) {
  viewer {
    accounts(filter: { accountTag: $accountTag }) {
      # Workers Invocations メトリクス
      workersInvocationsAdaptive(
        limit: 10000
        filter: {
          scriptName: $scriptName
          datetime_geq: $datetimeStart
          datetime_lt: $datetimeEnd
        }
      ) {
        # 合計値
        sum {
          requests
          errors
          subrequests
        }

        # パーセンタイル
        quantiles {
          cpuTimeP50
          cpuTimeP90
          cpuTimeP95
          cpuTimeP99
          durationP50
          durationP90
          durationP95
          durationP99
        }

        # 時系列データ
        dimensions {
          datetime
          status
        }
      }

      # Durable Objects メトリクス
      durableObjectsInvocationsAdaptive(
        limit: 10000
        filter: {
          scriptName: $scriptName
          datetime_geq: $datetimeStart
          datetime_lt: $datetimeEnd
        }
      ) {
        sum {
          requests
          cpuTime
          activeTime
          inboundWebsocketMsgCount
          outboundWebsocketMsgCount
        }

        dimensions {
          className
          datetime
        }
      }

      # D1 メトリクス（利用可能な場合）
      d1QueriesAdaptive(
        limit: 10000
        filter: {
          datetime_geq: $datetimeStart
          datetime_lt: $datetimeEnd
        }
      ) {
        sum {
          readQueries
          writeQueries
          rowsRead
          rowsWritten
        }

        dimensions {
          databaseId
          datetime
        }
      }
    }
  }
}
