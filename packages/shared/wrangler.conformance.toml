name = "conformance-authrim-shared"
main = "src/durable-objects/index.ts"
compatibility_date = "2024-09-23"
compatibility_flags = ["nodejs_compat"]
workers_dev = false

# Durable Objects definitions
[[durable_objects.bindings]]
name = "SESSION_STORE"
class_name = "SessionStore"

[[durable_objects.bindings]]
name = "AUTH_CODE_STORE"
class_name = "AuthorizationCodeStore"

[[durable_objects.bindings]]
name = "REFRESH_TOKEN_ROTATOR"
class_name = "RefreshTokenRotator"

[[durable_objects.bindings]]
name = "KEY_MANAGER"
class_name = "KeyManager"

[[durable_objects.bindings]]
name = "CHALLENGE_STORE"
class_name = "ChallengeStore"

[[durable_objects.bindings]]
name = "RATE_LIMITER"
class_name = "RateLimiterCounter"

[[durable_objects.bindings]]
name = "PAR_REQUEST_STORE"
class_name = "PARRequestStore"

[[durable_objects.bindings]]
name = "DPOP_JTI_STORE"
class_name = "DPoPJTIStore"

# Durable Objects migrations
[[migrations]]
tag = "v1"
new_sqlite_classes = [
  "SessionStore",
  "AuthorizationCodeStore",
  "RefreshTokenRotator",
  "KeyManager",
  "ChallengeStore",
  "RateLimiterCounter",
  "PARRequestStore",
  "DPoPJTIStore"
]

[[migrations]]
tag = "v2"
# Empty migration to match production state
# Keeps existing Durable Objects intact

[[migrations]]
tag = "v3"
new_sqlite_classes = ["RateLimiterCounter", "PARRequestStore", "DPoPJTIStore"]

# Environment variables
# D1 Database
[[d1_databases]]
binding = "DB"
database_name = "conformance-authrim-users-db"
database_id = "92847b63-125e-4252-b189-3402895addb4"

[vars]
KEY_MANAGER_SECRET = "production-secret-change-me"
